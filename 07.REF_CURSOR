REF CURSOR (Reference Cursor)
------------------------------

What is a REF CURSOR?

  A REF CURSOR is a pointer (reference) to a query result.

üëâ Normal cursor = fixed query
üëâ REF CURSOR = query decided at runtime

Types of REF CURSOR in PL/SQL
  üîπ Weak REF CURSOR
  üîπ Strong REF CURSOR



1Ô∏è‚É£ Weak REF CURSOR
üîπ Definition

A Weak REF CURSOR has NO predefined structure.

Syntax
    TYPE ref_cur IS REF CURSOR;

or directly use:

    SYS_REFCURSOR

REF CURSOR, the syntax is:

    OPEN <ref_cursor_variable> FOR <SELECT statement>;

‚úÖ Example

DECLARE
  c SYS_REFCURSOR;
  v_name emp.ename%TYPE;
  v_sal  emp.sal%TYPE;
BEGIN
  OPEN c FOR
    SELECT ename, sal FROM emp;

  FETCH c INTO v_name, v_sal;
  DBMS_OUTPUT.PUT_LINE(v_name || ' ' || v_sal);

  CLOSE c;
END;
/



Why FOR is mandatory here
-------------------------
  A REF CURSOR is empty when declared.

TYPE emp_cur IS REF CURSOR;
c_emp emp_cur;   -- only a pointer (no query yet)


So Oracle needs to know:
Which query should this cursor point to?
That is done using:

OPEN c_emp FOR SELECT ...



Example :  Simple REF CURSOR
-------------------------------
DECLARE
  v_cur SYS_REFCURSOR;
  v_name emp.ename%TYPE;
BEGIN
  OPEN v_cur FOR
    SELECT ename FROM emp WHERE deptno = 10;

  FETCH v_cur INTO v_name;
  DBMS_OUTPUT.PUT_LINE(v_name);

  CLOSE v_cur;
END;
/


üîπ Normal cursor (static)
CURSOR c_emp IS SELECT * FROM emp;
OPEN c_emp;

üëâ Query is fixed at declaration time

üîπ REF CURSOR (dynamic)
c_emp emp_cur;
OPEN c_emp FOR SELECT * FROM emp;

üëâ Query is attached at runtime

That attachment is done using FOR

Why REF CURSOR is called Dynamic?

A REF CURSOR is called dynamic because the SQL query is NOT fixed at compile time.
Instead, it is decided and attached at runtime.

üî¥ Static Cursor (NOT dynamic)
CURSOR c_emp IS
  SELECT ename, sal FROM emp;

Characteristics
Query is hard-coded
Structure is fixed
Cannot change columns or tables
Decided at compile time

üëâ This is why it‚Äôs called static cursor

üü¢ REF CURSOR (Dynamic)

OPEN c_emp FOR
  SELECT ename, sal FROM emp;

Characteristics

Query is supplied at runtime
Can change:
tables
columns
WHERE conditions
Structure is not fixed

üëâ That flexibility makes it dynamic
----------------------------------------------------------------------------

2Ô∏è‚É£ Strong REF CURSOR
üîπ Definition
      A Strong REF CURSOR has a fixed return structure.

Syntax
  TYPE emp_cur IS REF CURSOR RETURN DATATYPE;

üìå Structure is checked at compile time

üîë CORE RULE (MOST IMPORTANT)
    üî• A STRONG REF CURSOR (RETURN) can return ONLY a RECORD type ‚Äî NOT a scalar datatype
‚ùå NOT allowed

VARCHAR2
NUMBER
EMP.ENAME%TYPE

‚úÖ Allowed
%ROWTYPE
User-defined record type

‚úÖ Example

DECLARE
  TYPE emp_cur IS REF CURSOR RETURN emp%ROWTYPE;
  c_emp emp_cur;

  v_emp emp%ROWTYPE;
BEGIN
  OPEN c_emp FOR
    SELECT * FROM emp;

  FETCH c_emp INTO v_emp;
  DBMS_OUTPUT.PUT_LINE(v_emp.ename || ' ' || v_emp.sal);

  CLOSE c_emp;
END;
/


‚ùå Compile-Time Error Example

OPEN c_emp FOR
  SELECT ename, sal FROM emp;

‚ùå Error because structure does not match emp%ROWTYPE.
1Ô∏è‚É£ RECORD + REF CURSOR (RETURN RECORD)
Example: RECORD + REF CURSOR

DECLARE
  -- Step 1: Define RECORD
  TYPE emp_rec IS RECORD (
    empno emp.empno%TYPE,
    ename emp.ename%TYPE,
    sal   emp.sal%TYPE
  );

  -- Step 2: Define REF CURSOR returning RECORD
  TYPE emp_cur_type IS REF CURSOR RETURN emp_rec;

  v_cur emp_cur_type;
  v_emp emp_rec;
BEGIN
  OPEN v_cur FOR
    SELECT empno, ename, sal FROM emp;

  LOOP
    FETCH v_cur INTO v_emp;
    EXIT WHEN v_cur%NOTFOUND;

    DBMS_OUTPUT.PUT_LINE(v_emp.empno || ' ' || v_emp.ename || ' ' || v_emp.sal);
  END LOOP;

  CLOSE v_cur;
END;
/


2Ô∏è‚É£ %ROWTYPE + REF CURSOR (RETURN %ROWTYPE)
Concept
%ROWTYPE creates a record with all columns
REF CURSOR returns entire table rows
RETURN emp%ROWTYPE ensures strong typing

Example: %ROWTYPE + REF CURSOR

DECLARE
  -- REF CURSOR returning full EMP row
  TYPE emp_cur_type IS REF CURSOR RETURN emp%ROWTYPE;

  v_cur emp_cur_type;
  v_emp emp%ROWTYPE;
BEGIN
  OPEN v_cur FOR
    SELECT * FROM emp;

  LOOP
    FETCH v_cur INTO v_emp;
    EXIT WHEN v_cur%NOTFOUND;

    DBMS_OUTPUT.PUT_LINE(v_emp.empno || ' ' || v_emp.ename || ' ' || v_emp.sal);
  END LOOP;

  CLOSE v_cur;
END;
/


